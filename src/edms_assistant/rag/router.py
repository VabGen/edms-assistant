import json
import logging
from typing import List, Dict
from langchain_openai import ChatOpenAI
from edms_assistant.core.settings import settings

logger = logging.getLogger(__name__)


async def route_question_to_file(
        question: str,
        chat_history: List[Dict],
        available_files: List[str]
) -> str:
    """
    –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å –∫ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É.

    –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
    - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞.
    - –£—Å—Ç–æ–π—á–∏–≤—ã–π JSON-–≤—ã–≤–æ–¥.
    - –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫ LLM (fallback –Ω–∞ –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª).
    - –£—á—ë—Ç —Ç–µ–º–∞—Ç–∏–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –±—É–¥—É—â–µ–º).
    """
    if not available_files:
        raise ValueError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏")

    # –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª ‚Äî —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    if len(available_files) == 1:
        return available_files[0]

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ (—Ç–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    history = " ".join(
        msg["content"] for msg in chat_history if msg["role"] == "user"
    ) if chat_history else ""

    context = f"–ò—Å—Ç–æ—Ä–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤: {history}\n–¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å: {question}" if history else question

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º LLM
    llm = ChatOpenAI(
        api_key="not-needed",
        base_url=str(settings.vllm.generative_base_url),
        model=settings.vllm.generative_model,
        temperature=0.0,
        max_tokens=128
    )

    # –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ‚Äî —á—ë—Ç–∫–∞—è —Ä–æ–ª—å –∏ —Ñ–æ—Ä–º–∞—Ç
    system_prompt = (
        "–¢—ã ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞ (–°–≠–î). "
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—ã–±—Ä–∞—Ç—å –û–î–ò–ù —Ñ–∞–π–ª –∏–∑ —Å–ø–∏—Å–∫–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –ù–ê–ò–ë–û–õ–ï–ï –í–ï–†–û–Ø–¢–ù–û —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å. "
        "–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏: —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–∞–º–∏, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏, –ø—Ä–∏–∫–∞–∑–∞–º–∏, —Ñ–æ—Ä–º–∞–º–∏, —Ç–∞–±–ª–∏—Ü–∞–º–∏."
    )

    user_prompt = f"""–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã.
2. –í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª, –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –ø–æ –¢–ï–ú–ê–¢–ò–ö–ï –∏ –ö–û–ù–¢–ï–ö–°–¢–£.
3. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
{{"filename": "—Ç–æ—á–Ω–æ–µ_–∏–º—è_—Ñ–∞–π–ª–∞_—Å_—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º", "reason": "–∫–ª—é—á–µ–≤–∞—è_—Ç–µ–º–∞"}}

–ü—Ä–∏–º–µ—Ä:
–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã: ["–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ_–ø–æ_EDMS.docx", "–ü—Ä–∏–∫–∞–∑—ã_2024.pdf", "–¢–∞–±–ª–∏—Ü–∞_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö.xlsx"]
–ö–æ–Ω—Ç–µ–∫—Å—Ç:
–¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å: –ö—Ç–æ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–µ—Ç –ø—Ä–∏–∫–∞–∑—ã –≤ –æ—Ç–¥–µ–ª–µ –ø—Ä–æ–¥–∞–∂?
–û—Ç–≤–µ—Ç:
{{"filename": "–¢–∞–±–ª–∏—Ü–∞_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö.xlsx", "reason": "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö"}}

–¢–µ–ø–µ—Ä—å —Ç–≤–æ—è –æ—á–µ—Ä–µ–¥—å:

–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã: {available_files}

–ö–æ–Ω—Ç–µ–∫—Å—Ç:
{context}

–û—Ç–≤–µ—Ç:"""

    try:
        # –í—ã–∑—ã–≤–∞–µ–º LLM —Å —è–≤–Ω—ã–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Ä–æ–ª–µ–π
        resp = await llm.ainvoke([
            ("system", system_prompt),
            ("user", user_prompt)
        ])

        # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (–∏–Ω–æ–≥–¥–∞ LLM –¥–æ–±–∞–≤–ª—è–µ—Ç "```json")
        raw_content = resp.content.strip()
        if raw_content.startswith("```json"):
            raw_content = raw_content[7:]  # –£–±–∏—Ä–∞–µ–º ```json
        if raw_content.endswith("```"):
            raw_content = raw_content[:-3]  # –£–±–∏—Ä–∞–µ–º ```

        # –ü–∞—Ä—Å–∏–º JSON
        data = json.loads(raw_content)
        fname = data.get("filename", "").strip()
        reason = data.get("reason", "no reason")

        # –í–∞–ª–∏–¥–∞—Ü–∏—è: —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ
        if fname in available_files:
            logger.debug(f"‚úÖ –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è: {fname} (–ø—Ä–∏—á–∏–Ω–∞: {reason})")
            return fname
        else:
            logger.warning(f"‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –≤ –æ—Ç–≤–µ—Ç–µ LLM: '{fname}'. –î–æ—Å—Ç—É–ø–Ω—ã: {available_files}")

    except (json.JSONDecodeError, KeyError, TypeError) as e:
        logger.warning(
            f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç LLM: {e}. –û—Ç–≤–µ—Ç –±—ã–ª: {resp.content if 'resp' in locals() else 'N/A'}")
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏: {e}")

    # Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª
    fallback = available_files[0]
    logger.debug(f"üîÄ Fallback –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏: {fallback}")
    return fallback